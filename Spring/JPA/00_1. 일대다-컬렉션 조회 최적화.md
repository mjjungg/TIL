# ì¼ëŒ€ë‹¤-ì»¬ë ‰ì…˜ ì¡°íšŒ

## Order-OrderedItem-Item  **(Orderì—ì„œ Item í•„ë“œ ì ‘ê·¼)**

1 : N : 1 ê´€ê³„ì¼ ë•Œ, Orderì—ì„œ OrderedItem ì»¬ë ‰ì…˜ ì¡°íšŒ + OrderedItem ì»¬ë ‰ì…˜ ê°ê°ì˜ OrderedItemì— ëŒ€í•´ Itemì˜ í•„ë“œê°’ ê°€ì ¸ì˜¨ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜í•´ì•¼ í•  ë•Œ 

**ì–´ë–»ê²Œ ìµœì í™”?**

## Step 1. DTOë¥¼ ë‘ ë²ˆ ë§Œë“¤ì

OrderDto, OrderedItemDto ìƒì„± â†’ ì—”í‹°í‹° ë…¸ì¶œ X

â­ í¬ì¸íŠ¸ëŠ” ê²°ê³¼ê°’ìœ¼ë¡œ ë°˜í™˜í•  Order ë¿ë§Œ ì•„ë‹ˆë¼ ê·¸ ì†ì—ìˆëŠ” OrderedItem ê¹Œì§€ Dtoë¡œ ë§Œë“ ë‹¤. 

```java
@GetMapping("/api/v2/orders")
public List<OrderDto> ordersV2() {
	List<Order> orders = orderRepository.findAll();
	List<OrderDto> result = orders.stream()
	.map(o -> new OrderDto(o))
	.collect(toList());
	return result;
}

@Data
static class OrderDto {private Long orderId;
private String name;
private OrderStatus orderStatus;
private Address address;
private List<OrderItemDto> orderItems;
public OrderDto(Order order) {
	orderId = order.getId();
	name = order.getMember().getName();
	orderDate = order.getOrderDate();
	orderStatus = order.getStatus();
	address = order.getDelivery().getAddress();
	orderItems = order.getOrderItems().stream()
	.map(orderItem -> new OrderItemDto(orderItem))
	.collect(toList());
	}
}
@Data 
	static class OrderItemDto {    // ** orderedItemì—ì„œ namerê³¼ orderPriceë§Œ ê°€ì ¸ì˜´ 
	private String itemName;//ìƒí’ˆ ëª…
	private int orderPrice; //ì£¼ë¬¸ ê°€ê²©
	public OrderItemDto(OrderItem orderItem) {
	itemName = orderItem.getItem().getName();
	orderPrice = orderItem.getOrderPrice();
	}
}

```

 

OrderRepository.java

```java
public List<Order> findAll() {
        return em.createQuery("select o from Order o", Order.class)
                .getResultList();
    }
```

### ë¬¸ì œì 

1. Orderë¥¼ ë‹¤ ê°€ì ¸ì˜´ â†’ Orderê°€ 2ê°œ ì´ë©´ ë‚˜ì˜¨ Orderê°’ 2ê°œ â‡’ ì¿¼ë¦¬ 1ë²ˆ 
2. ë‚˜ì˜¨ Order 2ê°œê°€ ê°ê° Member, Delivery, OrderedItemê³¼ ì¡°ì¸ â‡’  ì¿¼ë¦¬ (1, 1, 2) x 2 â†’ 8ë²ˆ  

(í•œ Orderë‹¹ OrderedItemì´ 2ê°œë¼ê³  ê°€ì •í–ˆì„ ë•Œ)

**ğŸ™€ ì¿¼ë¦¬ê°€ ì–´ë§ˆë¬´ì‹œí•˜ê²Œ ë§ì´ ë‚˜ê°** 

## Step 2. í˜ì¹˜ ì¡°ì¸ ì‚¬ìš©

```java
@GetMapping("/api/v3/orders")
public List<OrderDto> ordersV3() {
	List<Order> orders = orderRepository.findAllWithItem();
	List<OrderDto> result = orders.stream()
	.map(o -> new OrderDto(o))
	.collect(toList());
	return result;
}

@Data
static class OrderDto {private Long orderId;
private String name;
private OrderStatus orderStatus;
private Address address;
private List<OrderItemDto> orderItems;
public OrderDto(Order order) {
	orderId = order.getId();
	name = order.getMember().getName();
	orderDate = order.getOrderDate();
	orderStatus = order.getStatus();
	address = order.getDelivery().getAddress();
	orderItems = order.getOrderItems().stream()
	.map(orderItem -> new OrderItemDto(orderItem))
	.collect(toList());
	}
}
@Data 
	static class OrderItemDto {    // ** orderedItemì—ì„œ namerê³¼ orderPriceë§Œ ê°€ì ¸ì˜´ 
	private String itemName;//ìƒí’ˆ ëª…
	private int orderPrice; //ì£¼ë¬¸ ê°€ê²©
	public OrderItemDto(OrderItem orderItem) {
	itemName = orderItem.getItem().getName();
	orderPrice = orderItem.getOrderPrice();
	}
}

```

ì• ì½”ë“œì—ì„œ orderRepositoryì˜ findAll ë©”ì„œë“œ(ì¿¼ë¦¬ ë‚ ë¦¬ëŠ” ë©”ì„œë“œ)ë§Œ ë°”ê¾¸ë©´ ë•¡!!

OrderRepository.java

```java
public List<Order> findAllWithItem() {
	return em.createQuery(
	"select distinct o from Order o" +
	" join fetch o.member m" +
	" join fetch o.delivery d" +
	" join fetch o.orderItems oi" +
	" join fetch oi.item i", Order.class)
	.getResultList();
}
```

fetch ì¡°ì¸ì„ ì‚¬ìš©í•´ì„œ ê°€ì ¸ì˜¬ ë•Œ í•œ ë°©ì— ê°€ì ¸ì˜¤ëŠ” ë°©ë²•! 

- **distinct** : JPAì—ì„œì˜ distinctëŠ” DBë¡œ distinct ê¸°ëŠ¥(ì¤‘ë³µ ì œê±°) ë‚ ë¦¬ëŠ” ê¸°ëŠ¥ + ê°™ì€ idê°’ì´ë©´ ì¤‘ë³µë˜ëŠ” ê°ì²´ ì•Œì•„ì„œ ì œê±°í•´ì£¼ëŠ” ê¸°ëŠ¥ì„ í•œë‹¤.

â— DBì—ì„œì˜ distict : ëª¨ë“  ë ˆì½”ë“œ ê°’ì´ ê°™ì•„ì•¼ ì¤‘ë³µì„ ì œê±°í•œë‹¤. 

But, JPAì—ì„œëŠ” ëª¨ë“  ë ˆì½”ë“œ ê°’ì´ ë‹¤ë¥´ë”ë¼ë„, ì¤‘ë³µëœ ê°ì²´ë¥¼ ê³„ì† ëŒê³  ê°€ì ¸ì˜¨ë‹¤ë©´, ì•Œì•„ì„œ ì œê±°í•´ ì¤€ë‹¤.

![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/5cf5e599-37d2-4de4-8617-0734417de389/Untitled.png)

ORDERëŠ” 2ê°œ ì´ì§€ë§Œ, ORDER_ITEMê³¼ ì¡°ì¸í•˜ê²Œ ë˜ë©´ **ORDERê°€ ë»¥íŠ€ê¸° ë¨** 

â‡’ JPAì˜ distinctê°€ ORDERê°€ 4ê°œ ì¤‘ ë»¥íŠ€ê¸°ëœ 2ê°œë¥¼ ì•Œì•„ì„œ ì œê±°í•´ì¤€ë‹¤(idê°’ì´ ê°™ìœ¼ë©´ ê°™ì€ ê°ì²´ë¼ ì¸ì‹í•´ì„œ) ë‹¨, dbì—ì„œ ì¡°ì¸í•œ ê²°ê³¼ëŠ” ê·¸ëŒ€ë¡œì´ë‹¤. ( dbì—ì„œì˜ distinctëŠ” ëª¨ë“  ë ˆì½”ë“œ ê°’ì´ ë™ì¼í•´ì•¼ ì œê±°í•˜ê¸° ë•Œë¬¸)

- ì¡°ì¸ í˜ì¹˜ ì‚¬ìš© â‡’ ì¿¼ë¦¬ í•œ ë°©ì´ë©´ ë!
- ë‹¨ì  : í˜ì´ì§•ì´ ë¶ˆê°€ëŠ¥í•˜ë‹¤(ë°ì´í„°ë¥¼ DBì—ì„œ ì½ì–´ì˜¤ê³  ë©”ëª¨ë¦¬ì—ì„œ í˜ì´ì§•í•´ë²„ë¦¬ê¸° ë•Œë¬¸)
- ë‹¨ì  : ì¤‘ë³µ ë°ì´í„°ë¥¼ dbì—ì„œ applicationìœ¼ë¡œ ë‹¤ ì „ì†¡í•˜ê¸° ë•Œë¬¸ì— ë°ì´í„° ì „ì†¡ë¥ ì´ ë†’ë‹¤.
- â—ì»¬ë ‰ì…˜ í˜ì¹˜ ì¡°ì¸ì€ 1ê°œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŒ. ì»¬ë ‰ì…˜ ë‘˜ ì´ìƒì— í˜ì¹˜ ì¡°ì¸ì„ ì‚¬ìš©í•˜ë©´ ì•ˆ ë¨!!!

â‡’ í˜ì´ì§•ì„ ì“°ì§€ ì•Šì„ê±°ë¼ë©´ ë‚˜ì˜ì§€ ì•Šì€ ë°©ë²•!

## Step 3. BatchSize ì‚¬ìš©

- ì¼ë‹¤ëŒ€ì—ì„œ ì¼(1)ì„ ê¸°ì¤€ìœ¼ë¡œ í˜ì´ì§•ì„ í•˜ëŠ” ê²ƒì´ ëª©ì ! But, ë°ì´í„°ëŠ” ë‹¤(N)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ row ê°€ ìƒì„±ë¨

â†’ Orderë¥¼ ê¸°ì¤€ìœ¼ë¡œ í˜ì´ì§•X, OrderItemì´ ê¸°ì¤€ì´ ë¨

â‡’ í•˜ì´ë²„ë„¤ì´íŠ¸ê°€ ê²½ê³  ë¡œê·¸ ë‚¨ê¸°ê³ , ëª¨ë“  DB ë°ì´í„° ì½ì–´ì„œ ë©”ëª¨ë¦¬ì—ì„œ í˜ì´ì§• ì‹œë„í•¨ â†’ ìµœì•…ì˜ ê²½ìš° ì¥ì• ë¡œ ì´ì–´ì§ˆ ìˆ˜ ìˆìŒ

1. XToOne ê´€ê³„ëŠ” ëª¨ë‘ Step2ì—ì„œ í–ˆë˜ ê²ƒ ì²˜ëŸ¼ í˜ì¹˜ì¡°ì¸í•œë‹¤. (Member, Delivery) â†’ ToOne ê´€ê³„ëŠ” ë»¥íŠ€ê¸°(rowìˆ˜ ì¦ê°€)ë˜ì§€ ì•Šìœ¼ë¯€ë¡œ í˜ì´ì§• ì¿¼ë¦¬ì— ì˜í–¥X
2. ì»¬ë ‰ì…˜(orderItems)ì€ ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì¡°íšŒ + BachSize ì ìš©

OrderRepository.java

```java
public List<Order> findAllWithMemberDelivery(int offset, int limit) {
	return em.createQuery(
	"select o from Order o" +
	" join fetch o.member m" +
	" join fetch o.delivery d", Order.class)
	.setFirstResult(offset)
	.setMaxResults(limit)
	.getResultList();
}
```

### BatchSize ì ìš© ë°©ë²•

1. ê¸€ë¡œë²Œ ì„¤ì •: yml íŒŒì¼ì— hibernate.default_batch_fetch_size: 100 ì¶”ê°€
2. ê°œë³„ ì„¤ì •: @BatchSize 

### BatchSizeë¡œ ì ìš©í•˜ë©´ ì–´ë–»ê²Œ ë˜ëƒ?

ì»¬ë ‰ì…˜ì´ë‚˜ í”„ë¡ì‹œ ê°ì²´ë¥¼ ì„¤ì •í•œ sizeë§Œí¼ í•œêº¼ë²ˆì— IN ì¿¼ë¦¬ë¡œ ì¡°íšŒí•¨ 

ì¿¼ë¦¬ ì˜ˆì‹œ)

....

where orderItems order_id in (?, ?)

### ì¥ì 

- ì¿¼ë¦¬ í˜¸ì¶œ ìˆ˜ : 1 + N â†’ 1 + 1 ë¡œ ìµœì í™” (í˜ì¹˜ ì¡°ì¸ë³´ë‹¤ ì¿¼ë¦¬ í˜¸ì¶œ ìˆ˜ ë§ìŒ)
- í˜ì¹˜ ì¡°ì¸ë³´ë‹¤ DB ë°ì´í„° ì „ì†¡ëŸ‰ ìµœì í™”
- í˜ì´ì§• ê°€ëŠ¥

> default_batch_fetch_sizeëŠ” 100~1000 ì‚¬ì´ë¥¼ ì„ íƒí•˜ëŠ” ê²ƒì„ ê¶Œì¥í•¨
>
